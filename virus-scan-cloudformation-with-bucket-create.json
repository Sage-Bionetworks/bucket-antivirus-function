{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Templated used to set up antivirus scanning of S3 bucket",
   "Parameters":{
      "CodeZipS3BucketParameter":{
         "Type":"String",
         "Description":"The name of the S3 bucket where the .zip file for the Lambda code resides"
      },
      "CodeZipS3KeyParameter":{
         "Type":"String",
         "Description":"The name of the S3 key where the .zip file for the Lambda code resides"
      },
      "BucketToScanName":{
         "Type":"String",
         "Description":"The name of the S3 bucket to be created for scanning"
      }
   },
   "Resources":{
      "BucketToScan":{
         "Type":"AWS::S3::Bucket",
         "DependsOn":[
            "VirusScannerLambda",
            "VirusScannerLambdaInvokePermission"
         ],
         "Properties":{
            "BucketName":{
               "Ref":"BucketToScanName"
            },
            "NotificationConfiguration":{
               "TopicConfigurations":[
                  {
                     "Event":"s3:ObjectCreated:*",
                     "Topic":{
                        "Ref":"ScanTriggerSNSTopic"
                     }
                  }
               ]
            }
         }
      },
      "DenyInfectedObjectDownloadPolicy":{
         "Type":"AWS::S3::BucketPolicy",
         "Properties":{
            "Bucket":{
               "Ref":"BucketToScanName"
            },
            "PolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Deny",
                     "Action":[
                        "s3:GetObject"
                     ],
                     "Principal":"*",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"BucketToScanName"
                              },
                              "/*"
                           ]
                        ]
                     },
                     "Condition":{
                        "StringEquals":{
                           "s3:ExistingObjectTag/av-status":"INFECTED"
                        }
                     }
                  }
               ]
            }
         }
      },
      "CloudWatchTimer":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "ScheduleExpression":"rate(3 hours)",
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "VirusScanDefinitionUpdaterLambda",
                        "Arn"
                     ]
                  },
                  "Id":"3hour-update-definitions"
               }
            ]
         }
      },
      "VirusDefinitionUpdaterLambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "DependsOn":[
            "VirusScanDefinitionUpdaterLambda",
            "CloudWatchTimer"
         ],
         "Properties":{
            "FunctionName":{
               "Fn::GetAtt":[
                  "VirusScanDefinitionUpdaterLambda",
                  "Arn"
               ]
            },
            "Action":"lambda:invokeFunction",
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "CloudWatchTimer",
                  "Arn"
               ]
            }
         }
      },
      "VirusScannerLambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "DependsOn":[
            "VirusScannerLambda"
         ],
         "Properties":{
            "FunctionName":{
               "Fn::GetAtt":[
                  "VirusScannerLambda",
                  "Arn"
               ]
            },
            "Action":"lambda:invokeFunction",
            "Principal":"sns.amazonaws.com",
            "SourceArn":{
               "Ref":"ScanTriggerSNSTopic"
            }
         }
      },
      "ScanResultSQS":{
         "Type":"AWS::SQS::Queue",
         "Properties":{

         }
      },
      "ScanResultQueuePolicy":{
         "Type":"AWS::SQS::QueuePolicy",
         "DependsOn":[
            "ScanResultSNSTopic",
            "ScanResultSQS"
         ],
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Id":{
                  "Fn::Join":[
                     "/",
                     [
                        {
                           "Fn::GetAtt":[
                              "ScanResultSQS",
                              "Arn"
                           ]
                        },
                        "SQSDefaultPolicy"
                     ]
                  ]
               },
               "Statement":[
                  {
                     "Sid":"allow-scan-result-sns",
                     "Effect":"Allow",
                     "Principal":"*",
                     "Action":[
                        "sqs:SendMessage"
                     ],
                     "Resource":"*",
                     "Condition":{
                        "ArnEquals":{
                           "aws:SourceArn":{
                              "Ref":"ScanResultSNSTopic"
                           }
                        }
                     }
                  }
               ]
            },
            "Queues":[
               {
                  "Ref":"ScanResultSQS"
               }
            ]
         }
      },
      "S3NotifySNSPolicy":{
         "Type":"AWS::SNS::TopicPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2008-10-17",
               "Id":"__default_policy_ID",
               "Statement":[
                  {
                     "Sid":"allow-s3-notification",
                     "Effect":"Allow",
                     "Principal":{
                        "AWS":"*"
                     },
                     "Action":"SNS:Publish",
                     "Resource":{
                        "Ref":"ScanTriggerSNSTopic"
                     },
                     "Condition":{
                        "ArnLike":{
                           "aws:SourceArn":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"BucketToScanName"
                                    }
                                 ]
                              ]
                           }
                        }
                     }
                  }
               ]
            },
            "Topics":[
               {
                  "Ref":"ScanTriggerSNSTopic"
               }
            ]
         }
      },
      "ScanTriggerSNSTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "Subscription":[
               {
                  "Endpoint":{
                     "Fn::GetAtt":[
                        "VirusScannerLambda",
                        "Arn"
                     ]
                  },
                  "Protocol":"lambda"
               }
            ]
         }
      },
      "ScanResultSNSTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "Subscription":[
               {
                  "Endpoint":{
                     "Fn::GetAtt":[
                        "ScanResultSQS",
                        "Arn"
                     ]
                  },
                  "Protocol":"sqs"
               }
            ]
         },
         "DependsOn":[
            "ScanResultSQS"
         ]
      },
      "VirusScannerLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Code":{
               "S3Bucket":{
                  "Ref":"CodeZipS3BucketParameter"
               },
               "S3Key":{
                  "Ref":"CodeZipS3KeyParameter"
               }
            },
            "Description":"Scans a file that was uploaded to S3",
            "Role":{
               "Fn::GetAtt":[
                  "VirusScannerRole",
                  "Arn"
               ]
            },
            "Timeout":300,
            "Runtime":"python2.7",
            "Handler":"scan.lambda_handler",
            "Environment":{
               "Variables":{
                  "AV_DEFINITION_S3_BUCKET":{
                     "Ref":"ClamavVirusDefinitionsBucket"
                  },
                  "AV_STATUS_SNS_ARN":{
                     "Ref":"ScanResultSNSTopic"
                  }
               }
            },
            "MemorySize":1024,
            "DeadLetterConfig":{
               "TargetArn":{
                  "Fn::GetAtt":[
                     "VirusScanDeadLetterQueue",
                     "Arn"
                  ]
               }
            }
         },
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "VirusScannerRole",
            "ScanResultSNSTopic",
            "VirusScanDeadLetterQueue"
         ]
      },
      "VirusScanDefinitionUpdaterLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Code":{
               "S3Bucket":{
                  "Ref":"CodeZipS3BucketParameter"
               },
               "S3Key":{
                  "Ref":"CodeZipS3KeyParameter"
               }
            },
            "Description":"Fetches latest ClamAV virus definitions and puts then into an S3 bucket",
            "Role":{
               "Fn::GetAtt":[
                  "VirusDefinitionUpdateRole",
                  "Arn"
               ]
            },
            "Timeout":300,
            "Runtime":"python2.7",
            "Handler":"update.lambda_handler",
            "Environment":{
               "Variables":{
                  "AV_DEFINITION_S3_BUCKET":{
                     "Ref":"ClamavVirusDefinitionsBucket"
                  }
               }
            },
            "MemorySize":512
         },
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "VirusDefinitionUpdateRole"
         ]
      },
      "ClamavVirusDefinitionsBucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{

         }
      },
      "VirusScanDeadLetterQueue":{
         "Type":"AWS::SQS::Queue",
         "Properties":{

         }
      },
      "VirusDefinitionUpdateRole":{
         "Type":"AWS::IAM::Role",
         "DependsOn":[
            "ClamavVirusDefinitionsBucket"
         ],
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"lambda.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"clamav-updater-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "s3:GetObject",
                              "s3:GetObjectTagging",
                              "s3:PutObject",
                              "s3:PutObjectTagging",
                              "s3:PutObjectVersionTagging"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    {
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    },
                                    "/*"
                                 ]
                              ]
                           }
                        }
                     ]
                  }
               }
            ]
         }
      },
      "VirusScannerRole":{
         "Type":"AWS::IAM::Role",
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "ScanResultSNSTopic",
            "VirusScanDeadLetterQueue"
         ],
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"lambda.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"clamav-scanner-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "s3:*"
                           ],
                           "Effect":"Allow",
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "sns:Publish",
                              "sns:Subscribe"
                           ],
                           "Effect":"Allow",
                           "Resource":[
                              {
                                 "Ref":"ScanResultSNSTopic"
                              }
                           ]
                        },
                        {
                           "Action":[
                              "sqs:SendMessage"
                           ],
                           "Effect":"Allow",
                           "Resource":[
                              {
                                 "Fn::GetAtt":[
                                    "VirusScanDeadLetterQueue",
                                    "Arn"
                                 ]
                              }
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      }
   }
}