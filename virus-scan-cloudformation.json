{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Templated used to set up antivirus scanning of S3 bucket",
   "Parameters":{
      "CodeZipS3BucketParameter":{
         "Type":"String",
         "Description":"The name of the S3 bucket where the .zip file for the Lambda code resides"
      },
      "CodeZipS3KeyParameter":{
         "Type":"String",
         "Description":"The name of the S3 key where the .zip file for the Lambda code resides"
      },
      "BucketToScanName":{
         "Type":"String",
         "Description":"The name of the S3 bucket to be created for scanning"
      },
      "InfectedFileNotificationEmail":{
         "Type":"String",
         "Description":"Email address to be notified when an INFECTED file is found"
      }
   },
   "Resources":{
      "VirusScanStackInit":{
         "Type":"AWS::CloudFormation::CustomResource",
         "Version":"1.0",
         "Description":"Sets up notification for the BucketToScanName and triggers the VirusScanDefinitionUpdaterLambda to run once",
         "Properties":{
            "ServiceToken":{
               "Fn::GetAtt":[
                  "VirusScanStackInitLambda",
                  "Arn"
               ]
            },
            "NotificationKwargs":{
               "Bucket":{
                  "Ref":"BucketToScanName"
               },
               "NotificationConfiguration":{
                  "TopicConfigurations":[
                     {
                        "Id":"bucket-scan-notify-sns",
                        "TopicArn":{
                           "Ref":"ScanTriggerSNSTopic"
                        },
                        "Events":[
                           "s3:ObjectCreated:CompleteMultipartUpload"
                        ]
                     }
                  ]
               }
            },
            "VirusDefinitionUpdateLambdaName":{
               "Ref":"VirusScanDefinitionUpdaterLambda"
            },
            "VirusDefinitionBucketName":{
               "Ref":"ClamavVirusDefinitionsBucket"
            }
         }
      },
      "VirusScanStackInitLambda":{
         "Type":"AWS::Lambda::Function",
         "DependsOn":[
            "VirusScanDefinitionUpdaterLambda",
            "ScanTriggerSNSTopic"
         ],
         "Description":"Sets up notification for the BucketToScanName and triggers the VirusScanDefinitionUpdaterLambda to run once",
         "Properties":{
            "Code":{
               "ZipFile":{
                  "Fn::Join":[
                     "\n",
                     [
                        "import json",
                        "import cfnresponse",
                        "import boto3",
                        "from collections import defaultdict",
                        "def lambda_handler(event, context):",
                        "   print(event)",
                        "   responseData = {}",
                        "   responseData['Data'] = ''",
                        "   try:",
                        "      s3_client = boto3.client('s3')",
                        "      notification_kwargs = event['ResourceProperties']['NotificationKwargs']",
                        "      new_notification_config_id = notification_kwargs['NotificationConfiguration']['TopicConfigurations'][0]['Id']",
                        "      curr_notification_config = s3_client.get_bucket_notification_configuration(Bucket=notification_kwargs['Bucket'])",
                        "      curr_notification_config.pop('ResponseMetadata')",
                        "      if event['RequestType'] == 'Update': # remove notification config set by previous instance of this lambda before merging configs",
                        "         if 'TopicConfigurations' in curr_notification_config:",
                        "            curr_notification_config['TopicConfigurations'] = [x for x in curr_notification_config['TopicConfigurations'] if x['Id'] != new_notification_config_id]",
                        "      merged_notification_config = defaultdict(list)",
                        "      merged_notification_config.update(notification_kwargs['NotificationConfiguration'])",
                        "      for k,v in curr_notification_config.iteritems():",
                        "         merged_notification_config[k].extend(v)",
                        "      notification_kwargs['NotificationConfiguration'] = merged_notification_config",
                        "      if event['RequestType'] == 'Create':",
                        "         print('triggering virus definition update lambda function')",
                        "         lambda_client = boto3.client('lambda')",
                        "         lambda_client.invoke(FunctionName=event['ResourceProperties']['VirusDefinitionUpdateLambdaName'],InvocationType='Event')",
                        "      if event['RequestType'] == 'Delete':",
                        "         print('Deleting objects from virus definition bucket')",
                        "         virus_def_bucket = boto3.resource('s3').Bucket(event['ResourceProperties']['VirusDefinitionBucketName'])",
                        "         virus_def_bucket.objects.all().delete()",
                        "         merged_notification_config['TopicConfigurations'] = [x for x in merged_notification_config['TopicConfigurations'] if x['Id'] != new_notification_config_id]",
                        "      print('Modifying notification configuration')",
                        "      s3_client.put_bucket_notification_configuration(**notification_kwargs)",
                        "      cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)",
                        "   except:",
                        "      cfnresponse.send(event, context, cfnresponse.FAILED, responseData)",
                        "      raise"
                     ]
                  ]
               }
            },
            "Description":"Lambda used to update a bucket's notification setting ",
            "Handler":"index.lambda_handler",
            "Role":{
               "Fn::GetAtt":[
                  "VirusScanStackInitRole",
                  "Arn"
               ]
            },
            "Runtime":"python2.7",
            "Timeout":100
         }
      },
      "DenyInfectedObjectDownloadPolicy":{
         "Type":"AWS::S3::BucketPolicy",
         "Properties":{
            "Bucket":{
               "Ref":"BucketToScanName"
            },
            "PolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Deny",
                     "Action":[
                        "s3:GetObject"
                     ],
                     "Principal":"*",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"BucketToScanName"
                              },
                              "/*"
                           ]
                        ]
                     },
                     "Condition":{
                        "StringEquals":{
                           "s3:ExistingObjectTag/av-status":"INFECTED"
                        }
                     }
                  }
               ]
            }
         }
      },
      "CloudWatchTimer":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "ScheduleExpression":"rate(3 hours)",
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "VirusScanDefinitionUpdaterLambda",
                        "Arn"
                     ]
                  },
                  "Id":"3hour-update-definitions"
               }
            ]
         }
      },
      "VirusDefinitionUpdaterLambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "DependsOn":[
            "VirusScanDefinitionUpdaterLambda",
            "CloudWatchTimer"
         ],
         "Properties":{
            "FunctionName":{
               "Fn::GetAtt":[
                  "VirusScanDefinitionUpdaterLambda",
                  "Arn"
               ]
            },
            "Action":"lambda:invokeFunction",
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "CloudWatchTimer",
                  "Arn"
               ]
            }
         }
      },
      "VirusScannerLambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "DependsOn":[
            "VirusScannerLambda"
         ],
         "Properties":{
            "FunctionName":{
               "Fn::GetAtt":[
                  "VirusScannerLambda",
                  "Arn"
               ]
            },
            "Action":"lambda:invokeFunction",
            "Principal":"sns.amazonaws.com",
            "SourceArn":{
               "Ref":"ScanTriggerSNSTopic"
            }
         }
      },
      "ScanResultSQS":{
         "Type":"AWS::SQS::Queue",
         "Properties":{

         }
      },
      "ScanResultQueuePolicy":{
         "Type":"AWS::SQS::QueuePolicy",
         "DependsOn":[
            "ScanResultSNSTopic",
            "ScanResultSQS"
         ],
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Id":{
                  "Fn::Join":[
                     "/",
                     [
                        {
                           "Fn::GetAtt":[
                              "ScanResultSQS",
                              "Arn"
                           ]
                        },
                        "SQSDefaultPolicy"
                     ]
                  ]
               },
               "Statement":[
                  {
                     "Sid":"allow-scan-result-sns",
                     "Effect":"Allow",
                     "Principal":"*",
                     "Action":[
                        "sqs:SendMessage"
                     ],
                     "Resource":"*",
                     "Condition":{
                        "ArnEquals":{
                           "aws:SourceArn":{
                              "Ref":"ScanResultSNSTopic"
                           }
                        }
                     }
                  }
               ]
            },
            "Queues":[
               {
                  "Ref":"ScanResultSQS"
               }
            ]
         }
      },
      "S3NotifySNSPolicy":{
         "Type":"AWS::SNS::TopicPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2008-10-17",
               "Id":"__default_policy_ID",
               "Statement":[
                  {
                     "Sid":"allow-s3-notification",
                     "Effect":"Allow",
                     "Principal":{
                        "AWS":"*"
                     },
                     "Action":"SNS:Publish",
                     "Resource":{
                        "Ref":"ScanTriggerSNSTopic"
                     },
                     "Condition":{
                        "ArnLike":{
                           "aws:SourceArn":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"BucketToScanName"
                                    }
                                 ]
                              ]
                           }
                        }
                     }
                  }
               ]
            },
            "Topics":[
               {
                  "Ref":"ScanTriggerSNSTopic"
               }
            ]
         }
      },
      "ScanTriggerSNSTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "Subscription":[
               {
                  "Endpoint":{
                     "Fn::GetAtt":[
                        "VirusScannerLambda",
                        "Arn"
                     ]
                  },
                  "Protocol":"lambda"
               }
            ]
         }
      },
      "ScanResultSNSTopic":{
         "Type":"AWS::SNS::Topic",
         "Properties":{
            "Subscription":[
               {
                  "Endpoint":{
                     "Fn::GetAtt":[
                        "ScanResultSQS",
                        "Arn"
                     ]
                  },
                  "Protocol":"sqs"
               },
               {
                  "Endpoint":{
                     "Ref":"InfectedFileNotificationEmail"
                  },
                  "Protocol":"email"
               }
            ]
         },
         "DependsOn":[
            "ScanResultSQS"
         ]
      },
      "VirusScannerLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Code":{
               "S3Bucket":{
                  "Ref":"CodeZipS3BucketParameter"
               },
               "S3Key":{
                  "Ref":"CodeZipS3KeyParameter"
               }
            },
            "Description":"Scans a file that was uploaded to S3",
            "Role":{
               "Fn::GetAtt":[
                  "VirusScannerRole",
                  "Arn"
               ]
            },
            "Timeout":300,
            "Runtime":"python3.7",
            "Handler":"scan.lambda_handler",
            "Environment":{
               "Variables":{
                  "AV_DEFINITION_S3_BUCKET":{
                     "Ref":"ClamavVirusDefinitionsBucket"
                  },
                  "AV_STATUS_SNS_ARN":{
                     "Ref":"ScanResultSNSTopic"
                  },
                  "AV_STATUS_SNS_PUBLISH_CLEAN": "False",
                  "EVENT_SOURCE":"SNS"
               }
            },
            "MemorySize":1024,
            "DeadLetterConfig":{
               "TargetArn":{
                  "Fn::GetAtt":[
                     "VirusScanDeadLetterQueue",
                     "Arn"
                  ]
               }
            }
         },
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "VirusScannerRole",
            "ScanResultSNSTopic",
            "VirusScanDeadLetterQueue"
         ]
      },
      "VirusScanDefinitionUpdaterLambda":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "Code":{
               "S3Bucket":{
                  "Ref":"CodeZipS3BucketParameter"
               },
               "S3Key":{
                  "Ref":"CodeZipS3KeyParameter"
               }
            },
            "Description":"Fetches latest ClamAV virus definitions and puts then into an S3 bucket",
            "Role":{
               "Fn::GetAtt":[
                  "VirusDefinitionUpdateRole",
                  "Arn"
               ]
            },
            "Timeout":300,
            "Runtime":"python3.7",
            "Handler":"update.lambda_handler",
            "Environment":{
               "Variables":{
                  "AV_DEFINITION_S3_BUCKET":{
                     "Ref":"ClamavVirusDefinitionsBucket"
                  }
               }
            },
            "MemorySize":1024
         },
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "VirusDefinitionUpdateRole"
         ]
      },
      "ClamavVirusDefinitionsBucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{

         }
      },
      "VirusScanDeadLetterQueue":{
         "Type":"AWS::SQS::Queue",
         "Properties":{

         }
      },
      "VirusScanStackInitRole":{
         "Type":"AWS::IAM::Role",
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "ScanResultSNSTopic",
            "VirusScanDeadLetterQueue"
         ],
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"lambda.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"virus-scan-stack-init-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "lambda:InvokeFunction"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "s3:*"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    {
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    },
                                    "*"
                                 ]
                              ]
                           }
                        },
                        {
                           "Action":[
                              "s3:GetBucketNotification",
                              "s3:PutBucketNotification"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"BucketToScanName"
                                    }
                                 ]
                              ]
                           }
                        }
                     ]
                  }
               }
            ]
         }
      },
      "VirusDefinitionUpdateRole":{
         "Type":"AWS::IAM::Role",
         "DependsOn":[
            "ClamavVirusDefinitionsBucket"
         ],
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"lambda.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"clamav-updater-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "s3:GetObject",
                              "s3:GetObjectTagging",
                              "s3:PutObject",
                              "s3:PutObjectTagging",
                              "s3:PutObjectVersionTagging",
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    {
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    },
                                    "/*"
                                 ]
                              ]
                           }
                        },
                        {
                           "Action":[
                              "s3:ListBucket"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    }
                        }
                     ]
                  }
               }
            ]
         }
      },
      "VirusScannerRole":{
         "Type":"AWS::IAM::Role",
         "DependsOn":[
            "ClamavVirusDefinitionsBucket",
            "ScanResultSNSTopic",
            "VirusScanDeadLetterQueue"
         ],
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":"lambda.amazonaws.com"
                     },
                     "Action":"sts:AssumeRole"
                  }
               ]
            },
            "Path":"/",
            "Policies":[
               {
                  "PolicyName":"clamav-scanner-policy",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Resource":"*"
                        },
                        {
                           "Action":[
                              "s3:GetObject",
                              "s3:GetObjectTagging",
                              "s3:PutObjectTagging",
                              "s3:PutObjectVersionTagging"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"BucketToScanName"
                                    },
                                    "/*"
                                 ]
                              ]
                           }
                        },
                        {
                           "Action":[
                              "s3:ListBucket"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    "arn:aws:s3:::",
                                    {
                                       "Ref":"BucketToScanName"
                                    }
                                 ]
                              ]
                           }
                        },
                        {
                           "Action":[
                              "s3:GetObject",
                              "s3:GetObjectTagging",
                              "s3:PutObject",
                              "s3:PutObjectTagging",
                              "s3:PutObjectVersionTagging"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                              "Fn::Join":[
                                 "",
                                 [
                                    {
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    },
                                    "/*"
                                 ]
                              ]
                           }
                        },
                        {
                           "Action":[
                              "s3:ListBucket"
                           ],
                           "Effect":"Allow",
                           "Resource":{
                                       "Fn::GetAtt":[
                                          "ClamavVirusDefinitionsBucket",
                                          "Arn"
                                       ]
                                    }
                        },
                        {
                           "Action":[
                              "sns:Publish",
                              "sns:Subscribe"
                           ],
                           "Effect":"Allow",
                           "Resource":[
                              {
                                 "Ref":"ScanResultSNSTopic"
                              }
                           ]
                        },
                        {
                           "Action":[
                              "sqs:SendMessage"
                           ],
                           "Effect":"Allow",
                           "Resource":[
                              {
                                 "Fn::GetAtt":[
                                    "VirusScanDeadLetterQueue",
                                    "Arn"
                                 ]
                              }
                           ]
                        }
                     ]
                  }
               }
            ]
         }
      }
   }
}
